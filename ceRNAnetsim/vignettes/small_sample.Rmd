---
title: "Approach of the Method in A Small Sample"
author: "Selcen Ari"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Approach of the Method in A Small Sample}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```


# Introduction

This vignette demonstrates how to analysis miRNA:Competing interactions via `ceRNAnetsim` package.The perturbations in the miRNA:target interactions are handled step by step in `ceRNAnetsim`. The package determines and simulates regulation of miRNA:competing RNA interactions based on amounts of miRNA and the targets and interaction factors.

The `ceRNAnetsim` works as followings:

- The dataset that is wanted to analysis  is organized. The first variable is arranged as competing and the second as miRNA.
- The dataset is ran with `priming_graph()` for convertion to graph. This function makes calculations that are depended on miRNA amount, target (competing) amount and the interaction factors. It determines the efficiency of mirna to each target and saves that values as egde data. All calculations are performed in edge data. After that, results of calculations are used in node data.
- The calculated values in edge are carried to node data through `update_nodes`. Note that the function should be used with `once = TRUE` argument after the `priming_graph()`.
- Now, the change could be executed with `update_variables` or `update_how`.
- The change are perceived as a trigger by the interactions in network.
- The trigger is used for simulation of regulations in `simulate()` or `simulate_vis()`.
- As the results of these processes, the different outputs could be obtained such as views of graphs or graph objects.


The workflow of `ceRNAnetsim` are shown as following:



```{r pressure, echo=FALSE, fig.align='center', fig.width=4, fig.height=3, dpi=120}

knitr::include_graphics("model_vignette.png")
```



## Installation of ceRNAnetsim

```{r, message=FALSE,warning=FALSE}
#install.packages("devtools")
#devtools::install_github("selcenari/ceRNAnetsim")


library(ceRNAnetsim)
```

```{r, echo=FALSE, message= FALSE, warning=FALSE}
library(rlang)
library(dplyr)
library(tidyr)
library(stringr)
library(stringi)
library(tidyverse)
library(ggplot2)
library(tidygraph)
library(igraph)
library(ggraph)
library(purrr)
library(future)
library(furrr)
library(png)
```

## Load the *minsamp*

In this vignette, the model functions are shown with using small dataset.
*minsamp* is a sample dataset that includes 6 genes, 2 miRNAs and interaction factors of miRNA:gene pairs.

```{r}
data("minsamp")

minsamp
```

## How to convert the dataset to graph.

minsamp is processed with `priming_graph()` function in first step. This provides convertion of dataset to graph object. In this step includes followings:


- The competing elements (Genes in *minsamp*) are grouped according to the miRNAs they are associated.
- In graph object, the interaction factors that are given optionally are processed and gradated inside the groups.
- The amounts (expressions) of miRNAs are apportioned according to competing:total competing ratio.
- miRNA efficiency in steady-state is calculated by taking account of these values and gradated factors.

```{r}
priming_graph(minsamp, competing_count = Competing_expression, miRNA_count = miRNA_expression,
              aff_factor = c(energy, seed_type), deg_factor = region)
```

## How to process edge data as node variables. 
  In the processed data, the values are carried as node variables with `update_nodes(once=TRUE)`. This function provides to define variable types. 

```{r}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)
```

## The change in the graph object.

In the steady-state, the mirna efficiency are assumed as stabil. But, If one or more change appears in the network, the system tends to be steady-state again. 

The `ceRNAnetsim` pakage exhibits two method for change in data. `update_variables()` and `update_how()` provide to apply the trigger that can start the unsteady-state. 

The update_variables: An additional dataset that is equal in terms of nodes is used. The dataset includes changed and unchanged values of node amounts. 

Firstly load the new_count (current_count dataset of minsamp):

```{r}
data(new_counts) #The Competing_count of Gene2 node is changed to two fold.)

new_counts

```

### The change in dataset: Method 1

`update_variables()` puts the changed values instead of previous. The function makes control to all values of the given dataset, so it allows more than one change. 

```{r}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_variables(current_counts = new_counts)
```

### The change in dataset: Method 2

The other method is the change in given node name with `update_how()`. If the user wants to apply the change in a node, `update_how()` could be used.
  
```{r}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_how(node_name = "Gene3", how = 2)

```

## Update the node variables again.

The node variables updates again after the change in edge. This step are applied for easy tracking.

```{r}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_variables(current_counts = new_counts)%>%
   update_nodes()

#or

minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_how("Gene2", how = 2)%>%
   update_nodes()

```

## Simulate the model.

When the change applied the interaction network, because of disruption in the interactions of miRNA:target ratios in groups, the steady-state conditions are assumed to breakdown. So, the system tends to be steady-state again. The change triggers the changes of other interactions in network, and then the rearrangement are continued until the gaining steady-state.

With `simulate()` function the changes in the system, are calculated continuously.

```{r}

minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_variables(current_counts = new_counts)%>%
   update_nodes()%>%
   simulate(cycle=10)

```

  `simulate()` saves the variables of each iteration in lists that are found in edge data of graph.The changes of variables can be scanned in lists with using basic `dplyr` functions. For example:
  
```{r}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_variables(current_counts = new_counts)%>%
   update_nodes()%>%
   simulate(cycle=10)%>%
   activate(edges)%>%       #from tidygraph package 
   select(comp_count_list, mirna_count_list)
```
  
## Visualisation of the graph

The `vis_graph` is carried out the visualisation of graph object. The initial graph object (steady-state) is visualized as following:
  
```{r, fig.height=4, fig.width=5, warning=FALSE, dpi= 120, fig.align='center'}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   vis_graph(title = "Minsamp initial Graph")


```
  
  Also, The graph can be visualized into any step of process.

```{r, fig.height=4, fig.width=5, warning=FALSE, dpi= 120, fig.align='center'}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_variables(current_counts = new_counts)%>%
   update_nodes()%>%
   simulate(3)%>%
   vis_graph(title = "Minsamp Graph After 3 Iteration")
```

  On the other hand, the view of each steps can be obtained by using `simulate_vis()` separately. `simulate_vis` processes the given graph like in `simulate()` and gives the views of each steps.
  
```{r, fig.height=4, fig.width=5, warning=FALSE, message=FALSE, fig.show='hide'}
minsamp%>%
   priming_graph(competing_count = Competing_expression, miRNA_count = miRNA_expression,
                 aff_factor = c(energy, seed_type), deg_factor = region)%>%
   update_nodes(once=TRUE)%>%
   update_variables(current_counts = new_counts)%>%
   update_nodes()%>%
   simulate_vis(3, title = "Minsamp Graph After Each Iteration")
```

![Minsamp with 3 iteraion](small_sample.gif)

 See the other vignettes to more.


